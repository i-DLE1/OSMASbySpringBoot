<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.idle.osmas.seller.dao.RegistProjectMapper">
    <resultMap id="memberResultMap" type="com.idle.osmas.member.dto.MemberDTO">
        <id property="no" column="TBL_MEMBER_NO"/>
        <result property="id" column="TBL_MEMBER_ID"/>
        <result property="name" column="TBL_MEMBER_NAME"/>
        <result property="phone" column="TBL_MEMBER_PHONE"/>
    </resultMap>

    <resultMap type="com.idle.osmas.seller.dto.ProjectDTO" id="projectResultMap">
        <id property="no" column="TBL_PRJ_NO"/>
        <result property="title" column="TBL_PRJ_TITLE"/>
        <result property="content" column="TBL_PRJ_CONTENT"/>
        <result property="startDate" column="TBL_PRJ_START_DATE"/>
        <result property="endDate" column="TBL_PRJ_END_DATE"/>
        <result property="targetAmount" column="TBL_PRJ_TARGET_AMOUNT"/>
        <result property="currentAmount" column="TBL_PRJ_CURRENT_AMOUNT"/>
        <result property="registDate" column="TBL_PRJ_REGIST_DATE"/>
        <result property="views" column="VIEWS"/>

        <collection property="member" resultMap="memberResultMap"/>
        <collection property="category" resultMap="projectCategoryResultMap"/>
        <collection property="projectFileList" resultMap="projectFileResultMap"/>
        <collection property="projectFAQList" resultMap="projectFAQResultMap"/>
        <collection property="projectProgressList" resultMap="projectProgressResultMap"/>
        <collection property="projectNewsList" resultMap="projectNewsResultMap"/>
        <collection property="projectQnAList" resultMap="projectQnAResultMap"/>
    </resultMap>


    <resultMap id="productListResultMap" type="com.idle.osmas.seller.dto.ProductListDTO">
        <id property="no" column="NO"/>
        <association property="Project" resultMap="projectResultMap"/>
        <collection property="productList" resultMap="REF_PRODUCT_NO"/>
    </resultMap>


    <resultMap type="com.idle.osmas.seller.dto.ProjectCategoryDTO" id="projectCategoryResultMap">
        <id property="no" column="TBL_CATEGORY_NO"/>
        <result property="subNo" column="TBL_CATEGORY_SUB_NO"/>
        <result property="name" column="TBL_CATEGORY_NAME"/>
<!--        <association property="subCategory" column="projectCategoryResultMap"/>-->
    </resultMap>

    <resultMap id="projectFAQResultMap" type="com.idle.osmas.seller.dto.ProjectFAQDTO">
        <id property="no" column="TBL_PRJ_FAQ_NO"/>
        <result property="projectNo" column="TBL_PRJ_FAQ_REF_PRJ_NO"/>
        <result property="title" column="TBL_PRJ_FAQ_TITLE"/>
        <result property="content" column="TBL_PRJ_FAQ_CONTENT"/>
        <result property="registDate" column="TBL_PRJ_FAQ_REGIST_DATE"/>
        <association property="projectNo" resultMap="projectResultMap"/>
    </resultMap>

    <resultMap id="projectFileResultMap" type="com.idle.osmas.seller.dto.ProjectFileDTO">
        <id property="no" column="TBL_PRJ_FILE_NO"/>
        <result property="projectNo" column="TBL_PRJ_FILE_REF_PRJ_NO"/>
        <result property="originName" column="TBL_PRJ_FILE_ORIGIN_NAME"/>
        <result property="changeName" column="TBL_PRJ_FILE_CHANGE_NAME"/>
        <result property="registDate" column="TBL_PRJ_FILE_REGIST_DATE"/>
        <result property="type" column="TBL_PRJ_FILE_TYPE"/>
        <result property="deleteYN" column="TBL_PRJ_FILE_DELETE_YN"/>
    </resultMap>

    <resultMap id="projectNewsResultMap" type="com.idle.osmas.seller.dto.ProjectNewsDTO">
        <id property="no" column="TBL_PRJ_NEW_INFO_NO"/>
        <result property="title" column="TBL_PRJ_NEW_INFO_TITLE"/>
        <result property="content" column="TBL_PRJ_NEW_INFO_CONTENT"/>
        <result property="registDate" column="TBL_PRJ_NEW_INFO_REGIST_DATE"/>
        <result property="modifyDate" column="TBL_PRJ_NEW_INFO_MODIFY_DATE"/>
        <result property="deleteYN" column="TBL_PRJ_NEW_INFO_DELETE_YN"/>
        <result property="projectNo" column="TBL_PRJ_NEW_INFO_REF_PRJ_NO"/>
    </resultMap>

    <resultMap id="projectProgressResultMap" type="com.idle.osmas.seller.dto.ProjectProgressDTO">
        <id property="no" column="TBL_PRJ_PROGRESS_NO"/>
        <result property="content" column="TBL_PRJ_PROGRESS_CONTENT"/>
        <result property="registDate" column="TBL_PRJ_PROGRESS_REGIST_DATE"/>
        <result property="status" column="TBL_PRJ_PROGRESS_STATUS"/>
<!--        <result property="refProjectNo" column="TBL_PRJ_PROGRESS_REF_PRJ_NO"/>-->
<!--        <association property="projectNo" resultMap="projectResultMap"/>-->
    </resultMap>

    <resultMap id="productResultMap" type="com.idle.osmas.seller.dto.ProductDTO">
        <id property="no" column="TBL_PRODUCT_NO"/>
        <result property="name" column="TBL_PRODUCT_NAME"/>
        <result property="introduction" column="TBL_PRODUCT_INTRODUCTION"/>
        <result property="price" column="TBL_PRODUCT_PRICE"/>
        <result property="maxQuantity" column="TBL_PRODUCT_MAX_QUANTITY"/>
        <result property="status" column="TBL_PRODUCT_STATUS"/>
        <result property="size" column="TBL_PRODUCT_PRODUCT_SIZE"/>
    </resultMap>

    <select id="selectProjectById" resultMap="projectResultMap" parameterType="map">
        SELECT PRJ.NO,
               PRJ.TITLE,
               PRJ.START_DATE,
               PRJ.END_DATE,
               PRJ.TARGET_AMOUNT,
               TC.NAME
          FROM TBL_PRJ PRJ
          JOIN TBL_MEMBER TM on PRJ.REF_MEMBER_NO = TM.NO
          JOIN TBL_CATEGORY TC ON PRJ.REF_CATEGORY_NO = TC.NO
         WHERE PRJ.NO = #{projectNo}
--           AND TM.ID = '#{userId}
    </select>

    <select id="selectByCategoryType" resultMap="projectCategoryResultMap" parameterType="_int" >
        SELECT TC.NO AS TBL_CATEGORY_NO,
               TC.NAME AS TBL_CATEGORY_NAME
          FROM TBL_CATEGORY TC
        <if test="categoryNo == null">
         WHERE SUB_NO IS NULL
        </if>
        <if test="categoryNo != null">
         WHERE SUB_NO = #{categoryNo}
        </if>
    </select>

    <insert id="temporaryInsertProject" parameterType="com.idle.osmas.seller.dto.ProjectDTO" useGeneratedKeys="true" keyProperty="no">
        INSERT INTO TBL_PRJ PRJ
        (PRJ.NO, PRJ.TITLE, PRJ.REGIST_DATE,
        PRJ.START_DATE, PRJ.END_DATE, PRJ.TARGET_AMOUNT,
        PRJ.REF_MEMBER_NO, PRJ.REF_CATEGORY_NO)
        VALUES
        (SEQ_TBL_PRJ_NO.nextval, '${title}', SYSDATE,
        '${startDate}', '${endDate}',${targetAmount},
        1, ${category.no})

        <selectKey resultType="_int" order="AFTER" keyProperty="no">
            SELECT SEQ_TBL_PRJ_NO.currval FROM DUAL
        </selectKey>
    </insert>

    <insert id="temporaryInsertProjectProgress">
        INSERT INTO TBL_PRJ_PROGRESS TPP
        (TPP.NO, TPP.REGIST_DATE, TPP.STATUS,
        TPP.REF_PRJ_NO)
        VALUES
        (SEQ_TBL_PRJ_PROGRESS_NO.nextval, SYSDATE, '${projectProgress.status}',
        #{no})
    </insert>

</mapper>

